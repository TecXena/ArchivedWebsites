;(function(win, doc){
    "use strict";
    function AddHistoryUrl(obj){
        obj = obj ? obj : {}
        this.channelUrl = obj.channelUrl || location.protocol+"//"+location.hostname+"/?vt=4&urlHistory="+this.channelName();
        this.startTime = 0;
        this.endTime = 0;
        this.init();
    }
    AddHistoryUrl.prototype = {
        constructor : AddHistoryUrl,
        init : function(){
            this.goReturnChannel();
        },
        goReturnChannel : function(){
            this.startTime = Date.parse(new Date());
            // console.log(this.startTime,"startTime")
            if(this.HasHistoryUrl()){
                var hostLink = this.channelUrl;
                var liveLink = location.href;
                history.replaceState(null,'', hostLink);
                history.pushState('', '', liveLink);
                window.addEventListener("popstate", function(e) {
                    this.endTime = Date.parse(new Date());
                    if(this.endTime - this.startTime > 500 && location.href === hostLink){
                        this.suds_count();
                        setTimeout(function(){
                            location.href = hostLink;
                        },200);
                    }
                }.bind(this));
            }
        },
        HasHistoryUrl : function(){
            return history.pushState && !appType.Utils.isSinaNews() && !appType.Utils.isQQ() && !appType.Utils.isWeibo() && this.isChannel() && this.isOldAdd() && this.isWm() && this.isHomePage()&& this.isHttps() ;
        },
        suds_count : function(){
            var channelName = this.channelName();
            if(window.suds_count){
                window.suds_count({
                    'type' : 'sudsHistory',
                    'name' : channelName,  //频道标志
                    'title': '回退拦截',
                    'index': 0
                });
            }
        },
        getUrlString : function(paraName) {
            var sUrl  =  location.href;
            var sReg  =  "(?:\\?|&){1}"+paraName+"=([^&]*)"
            var re=new RegExp(sReg,"gi");
            re.exec(sUrl);
            return RegExp.$1;
        },
        channelName : function(){
            var hostname = location.hostname;
            return hostname.split('.')[0];
        },
        isChannel : function(){
            return document.referrer.indexOf(this.channelName()) == -1;
        },
        isOldAdd : function(){
            return document.referrer.indexOf("urlHistory="+this.channelName()) == -1;
        },
        isWm : function(){
            return this.getUrlString("wm") != 3206;
        },
        isHomePage : function(){
            return document.referrer.indexOf("sina.cn") == -1
        },
        isHttps: function() {
            return -1 == document.location.href.indexOf("pos=108")
        }
    }
    var appType = {}
    appType.Utils = {
        _UA : navigator.userAgent.toLowerCase(),
        UAIdentify : {
            weibo : 'weibo',
            qq : 'qq/',
            sinanews :'sinanews'
        },
        isInclude : function(allStr,str){
            return allStr.indexOf(str)>-1;
        },
        isSinaNews : function(){
            var _all = this.UAIdentify,
                _isSinaNews = this.isInclude(this._UA,_all.sinanews);
            if(_isSinaNews){
                return true;
            }else{
                return false;
            }
        },
        isWeibo : function(){
            var _all = this.UAIdentify,
            _isWeibo = this.isInclude(this._UA,_all.weibo);
            if( _isWeibo ){
                return true;
            }
            return false;
        },
        isQQ : function(){
            var _all = this.UAIdentify,
                _isQQ = this.isInclude(this._UA,_all.qq);
            if(_isQQ){
                return true
            }else{
                return false;
            }
        }
    }
    window.addEventListener("load", function() {
        var addHistory = new AddHistoryUrl();
    });
})(window, document);
